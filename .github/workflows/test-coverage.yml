name: Tests and Coverage

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 #v5.6.0
      with:
        python-version: "3.12"

    - name: Install uv
      uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6 #v6.6.1
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --frozen --group fastapi --dev

    - name: Run unit tests with coverage
      run: |
        echo "ðŸ§ª Running unit tests with coverage..."
        cd backend
        uv run coverage run -m pytest tests/unit/ -vv

    - name: Generate coverage report
      run: |
        echo "ðŸ“Š Generating coverage report..."
        uv run coverage report --show-missing
        uv run coverage xml

    # - name: Upload coverage reports to Codecov
    #   uses: codecov/codecov-action@fdcc8476540edceab3de004e990f80d881c6cc00 #v5.5.0
    #   with:
    #     file: backend/coverage.xml
    #     directory: backend/
    #     fail_ci_if_error: false
    #     verbose: true
    #   env:
    #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
