name: Tests and Coverage

on:
  push:
    branches: ["*"]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 #v5.6.0
      with:
        python-version: "3.12"

    - name: Install uv
      uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6 #v6.6.1
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --frozen --group fastapi --dev

    - name: Run unit tests with coverage
      run: |
        echo "ğŸ§ª Running backend unit tests with coverage..."
        uv run coverage run -m pytest tests/unit/ -vv

    - name: Generate coverage report
      run: |
        echo "ğŸ“Š Generating backend coverage report..."
        uv run coverage report --show-missing
        uv run coverage xml

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@fdcc8476540edceab3de004e990f80d881c6cc00 #v5.5.0
      with:
        files: backend/coverage.xml
        directory: backend/
        fail_ci_if_error: false
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  frontend-tests:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

    - name: Set up Node.js
      uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing frontend dependencies..."
        npm ci

    - name: Run unit tests
      run: |
        echo "ğŸ§ª Running frontend unit tests (integration tests skipped)..."
        npm run test:unit

    - name: Run type checking
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        npm run type-check
